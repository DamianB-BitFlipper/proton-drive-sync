import { FastifyPluginAsync } from "fastify";\nimport client from "./db";\nimport { z } from "zod";\n\nconst plugin: FastifyPluginAsync = async (server) => {\n  server.post("/users/register", async (req, reply) => {\n    const schema = z.object({ id: z.string(), publicKey: z.string() });\n    const body = schema.parse(req.body);\n    await client.query(\n      "INSERT INTO users(id, public_key) VALUES($1,$2) ON CONFLICT (id) DO UPDATE SET public_key = $2",\n      [body.id, body.publicKey]\n    );\n    return { ok: true };\n  });\n\n  server.post("/register-repo", async (req, reply) => {\n    const schema = z.object({\n      repoId: z.string().optional(),\n      ownerId: z.string(),\n      driveRootPath: z.string()\n    });\n    const body = schema.parse(req.body);\n    const repoId = body.repoId ?? crypto.randomUUID();\n    await client.query(\n      "INSERT INTO repos(id, owner_id, drive_root) VALUES($1, $2, $3) ON CONFLICT DO NOTHING",\n      [repoId, body.ownerId, body.driveRootPath]\n    );\n    return { repoId };\n  });\n\n  server.post("/upload-wrapped-key", async (req, reply) => {\n    const schema = z.object({\n      id: z.string(),\n      repoId: z.string(),\n      recipientId: z.string(),\n      ciphertext: z.string()\n    });\n    const body = schema.parse(req.body);\n    await client.query(\n      "INSERT INTO wrapped_keys(id, repo_id, recipient_id, ciphertext) VALUES($1,$2,$3,$4)",\n      [body.id, body.repoId, body.recipientId, body.ciphertext]\n    );\n    return { ok: true };\n  });\n\n  server.get("/wrapped-key", async (req, reply) => {\n    const repoId = String(req.query.repoId);\n    const userId = String(req.query.userId);\n    const res = await client.query(\n      "SELECT ciphertext FROM wrapped_keys WHERE repo_id=$1 AND recipient_id=$2",\n      [repoId, userId]\n    );\n    if (res.rowCount === 0) return reply.code(404).send({ error: "not found" });\n    return { ciphertext: res.rows[0].ciphertext };\n  });\n\n  server.get("/repo-meta", async (req, reply) => {\n    const repoId = String(req.query.repoId);\n    const res = await client.query("SELECT id, owner_id, drive_root, created_at FROM repos WHERE id=$1", [repoId]);\n    if (res.rowCount === 0) return reply.code(404).send({ error: "not found" });\n    return { repo: res.rows[0] };\n  });\n};\n\nexport default plugin;