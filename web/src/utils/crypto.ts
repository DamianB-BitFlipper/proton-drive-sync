import * as sodium from "libsodium-wrappers-sumo";\n\nexport async function ready() {\n  await sodium.ready;\n}\n\nexport function genRepoKey(): Uint8Array {\n  return sodium.randombytes_buf(sodium.crypto_aead_xchacha20poly1305_ietf_KEYBYTES);\n}\n\nexport function encryptObject(key: Uint8Array, plaintext: Uint8Array) {\n  const nonce = sodium.randombytes_buf(sodium.crypto_aead_xchacha20poly1305_ietf_NPUBBYTES);\n  const cipher = sodium.crypto_aead_xchacha20poly1305_ietf_encrypt(plaintext, null, null, nonce, key);\n  return {\n    version: 1,\n    nonce: sodium.to_base64(nonce, sodium.base64_variants.URLSAFE),\n    ciphertext: sodium.to_base64(cipher, sodium.base64_variants.URLSAFE)\n  };\n}\n\nexport function decryptObject(key: Uint8Array, payload: { nonce: string; ciphertext: string }) {\n  const nonce = sodium.from_base64(payload.nonce, sodium.base64_variants.URLSAFE);\n  const cipher = sodium.from_base64(payload.ciphertext, sodium.base64_variants.URLSAFE);\n  const plain = sodium.crypto_aead_xchacha20poly1305_ietf_decrypt(null, cipher, null, nonce, key);\n  return plain;\n}\n\n// Wrap repoKey for recipient using crypto_box_seal (anonymous public-key encryption)\nexport function wrapKeyForRecipient(repoKey: Uint8Array, recipientPublicKeyBase64: string) {\n  const recipientPk = sodium.from_base64(recipientPublicKeyBase64, sodium.base64_variants.URLSAFE);\n  const sealed = sodium.crypto_box_seal(repoKey, recipientPk);\n  return sodium.to_base64(sealed, sodium.base64_variants.URLSAFE);\n}\n\nexport function unwrapKey(sealedBase64: string, recipientPkBase64: string, recipientSkBase64: string) {\n  const sealed = sodium.from_base64(sealedBase64, sodium.base64_variants.URLSAFE);\n  const pk = sodium.from_base64(recipientPkBase64, sodium.base64_variants.URLSAFE);\n  const sk = sodium.from_base64(recipientSkBase64, sodium.base64_variants.URLSAFE);\n  const opened = sodium.crypto_box_seal_open(sealed, pk, sk);\n  return opened;\n}